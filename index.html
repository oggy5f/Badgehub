<script>
  (function () {
    var fidInput = document.getElementById("fidInput");
    var badgeTypeInput = document.getElementById("badgeTypeInput");
    var shapeSelect = document.getElementById("shapeSelect");
    var randomColorToggle = document.getElementById("randomColorToggle");
    var autoCopyToggle = document.getElementById("autoCopyToggle");
    var claimBtn = document.getElementById("claimBtn");
    var copyCaptionBtn = document.getElementById("copyCaptionBtn");
    var statusEl = document.getElementById("status");
    var captionTextEl = document.getElementById("captionText");

    var badgeMain = document.getElementById("badgeMain");
    var badgeCircle = document.getElementById("badgeCircle");
    var badgePill = document.getElementById("badgePill");
    var badgeFidText = document.getElementById("badgeFidText");
    var badgeTypeText = document.getElementById("badgeTypeText");
    var badgeDateText = document.getElementById("badgeDateText");

    var streakValue = document.getElementById("streakValue");
    var totalValue = document.getElementById("totalValue");
    var lastDayValue = document.getElementById("lastDayValue");
    var lastClaimLabel = document.getElementById("lastClaimLabel");

    var STORAGE_KEY = "badgehub_daily_data_v1";

    function todayISO() {
      var d = new Date();
      return d.toISOString().slice(0, 10);
    }

    function formatDateShort(iso) {
      if (!iso) return "-";
      var d = new Date(iso + "T00:00:00");
      return d.toLocaleDateString(undefined, {
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
      });
    }

    function dayDiff(a, b) {
      var da = new Date(a + "T00:00:00");
      var db = new Date(b + "T00:00:00");
      var ms = da - db;
      return Math.round(ms / (1000 * 60 * 60 * 24));
    }

    function randomGradient() {
      var colors = [
        ["#22c55e", "#16a34a"],
        ["#38bdf8", "#0ea5e9"],
        ["#a855f7", "#6366f1"],
        ["#f97316", "#facc15"],
        ["#ec4899", "#8b5cf6"]
      ];
      var i = Math.floor(Math.random() * colors.length);
      return (
        "linear-gradient(135deg, " +
        colors[i][0] +
        ", " +
        colors[i][1] +
        ")"
      );
    }

    function loadState() {
      var raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        return {
          total: 0,
          streak: 0,
          lastClaimDate: null,
          lastFid: "",
          lastType: "Daily Check-in"
        };
      }
      try {
        return JSON.parse(raw);
      } catch (e) {
        return {
          total: 0,
          streak: 0,
          lastClaimDate: null,
          lastFid: "",
          lastType: "Daily Check-in"
        };
      }
    }

    function saveState(state) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function updateCaption(state) {
      var fid = fidInput.value || "45613";
      var type = badgeTypeInput.value || "Daily Check-in";
      var caption =
        "#" +
        fid +
        " " +
        type +
        " badge earned\n\nStreak: " +
        state.streak +
        " days | Total: " +
        state.total +
        "\n#Badgehub #Base";
      captionTextEl.textContent = caption;
      return caption;
    }

    function updatePreview(state) {
      // stats text
      streakValue.textContent =
        state.streak + (state.streak === 1 ? " day" : " days");
      totalValue.textContent = String(state.total);
      lastDayValue.textContent = state.lastClaimDate
        ? formatDateShort(state.lastClaimDate)
        : "-";

      if (state.lastClaimDate) {
        lastClaimLabel.textContent =
          "Last claimed on " + formatDateShort(state.lastClaimDate);
      } else {
        lastClaimLabel.textContent = "Not claimed yet";
      }

      // badge text
      badgeFidText.textContent = fidInput.value || "45613";
      badgeTypeText.textContent = badgeTypeInput.value || "Daily Check-in";

      var dateText = state.lastClaimDate
        ? formatDateShort(state.lastClaimDate)
        : formatDateShort(todayISO());
      badgeDateText.textContent = dateText;

      // shape visibility
      var shape = shapeSelect.value;
      badgeCircle.style.display =
        shape === "circle" || shape === "both" ? "block" : "none";
      badgePill.style.display =
        shape === "pill" || shape === "both" ? "block" : "none";

      // color
      if (randomColorToggle.checked) {
        badgeMain.style.backgroundImage = randomGradient();
      } else {
        badgeMain.style.backgroundImage =
          "linear-gradient(135deg,#22c55e,#16a34a)";
      }

      updateCaption(state);
    }

    function showStatus(msg, type) {
      if (type === undefined) type = "";
      statusEl.textContent = msg;
      statusEl.className = "status " + type;
    }

    // initial state
    var state = loadState();

    // sirf pehli baar state se value set karo
    if (state.lastFid) fidInput.value = state.lastFid;
    if (state.lastType) badgeTypeInput.value = state.lastType;

    updatePreview(state);

    // claim button
    claimBtn.addEventListener("click", function () {
      var today = todayISO();

      if (state.lastClaimDate === today) {
        showStatus(
          "Today's badge already claimed. Please come back tomorrow.",
          "error"
        );
        return;
      }

      if (state.lastClaimDate) {
        var diff = dayDiff(today, state.lastClaimDate);
        if (diff === 1) {
          state.streak += 1;
        } else {
          state.streak = 1;
        }
      } else {
        state.streak = 1;
      }

      state.total += 1;
      state.lastClaimDate = today;
      state.lastFid = fidInput.value || "45613";
      state.lastType = badgeTypeInput.value || "Daily Check-in";

      saveState(state);
      updatePreview(state);
      showStatus("Badge claimed. Streak updated.", "success");

      if (autoCopyToggle.checked && navigator.clipboard) {
        var caption = updateCaption(state);
        navigator.clipboard.writeText(caption).catch(function () {
          console.log("Clipboard blocked");
        });
      }
    });

    // copy caption
    copyCaptionBtn.addEventListener("click", function () {
      var caption = updateCaption(state);
      if (!navigator.clipboard) {
        showStatus("Clipboard API not available.", "error");
        return;
      }
      navigator.clipboard
        .writeText(caption)
        .then(function () {
          showStatus("Caption copied.", "success");
        })
        .catch(function () {
          showStatus(
            "Clipboard permission blocked in this browser.",
            "error"
          );
        });
    });

    // input change pe live preview + state update
    fidInput.addEventListener("input", function () {
      state.lastFid = fidInput.value;
      saveState(state);
      updatePreview(state);
    });

    badgeTypeInput.addEventListener("input", function () {
      state.lastType = badgeTypeInput.value;
      saveState(state);
      updatePreview(state);
    });

    shapeSelect.addEventListener("change", function () {
      updatePreview(state);
    });

    randomColorToggle.addEventListener("change", function () {
      updatePreview(state);
    });
  })();
</script>
