<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Badgehub Daily & Weekly</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Inter,system-ui,Arial;background:#08101a;color:#e6eef6;padding:28px}
    .card{max-width:840px;margin:20px auto;padding:22px;border-radius:12px;background:linear-gradient(180deg,#071019 0%,#071520 100%);box-shadow:0 6px 30px rgba(0,0,0,.5)}
    h1{margin:0 0 18px;font-size:24px;color:#7fe0c9}
    input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:#051017;color:#eaf6f0}
    .row{display:flex;gap:10px;margin-top:12px;align-items:center}
    button{background:#1286d6;border:none;color:white;padding:12px 14px;border-radius:10px;cursor:pointer}
    button.secondary{background:#2b3942}
    .muted{color:#95a0a6;font-size:13px;margin-top:10px}
    .notice{color:#7ee077;margin-top:8px}
    .error{color:#ff6b6b;margin-top:8px}
    .preview{margin-top:18px;padding:12px;border-radius:8px;border:1px dashed rgba(255,255,255,.04);color:#dbeef3;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));}
    .small{font-size:13px;color:#b9d7e0}
  </style>

  <!-- Use UMD build of ethers v5 (browser-friendly) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>Badgehub Daily & Weekly Badge</h1>

    <label class="small">Your FID / name</label>
    <input id="fidInput" type="text" placeholder="enter your FID (e.g. anon)" />

    <div class="row" style="margin-top:12px">
      <button id="connectBtn">Connect Wallet</button>
      <button id="refreshBtn" class="secondary">Refresh</button>
      <div id="accountArea" style="margin-left:auto;" class="small muted">Not connected</div>
    </div>

    <div class="row" style="margin-top:16px">
      <button id="claimLocalBtn" class="secondary">Claim Today's Badge (local)</button>
      <button id="mintDailyBtn">Mint Daily Badge Onchain</button>
      <button id="mintWeekBtn">Mint Weekly Badge Onchain</button>
    </div>

    <div id="status" class="muted"></div>
    <div id="alert" class="error"></div>
    <div id="ok" class="notice"></div>

    <div class="preview" id="preview">
      <div><strong>Preview</strong></div>
      <div id="previewText" style="margin-top:10px">-</div>
      <div style="margin-top:8px" id="streakInfo">Streak: 0 | Last claim: -</div>
    </div>

    <div style="margin-top:12px" class="small muted">
      Tip: "local" claim stores data in your browser (for testing). Onchain mint will call the smart contract.
    </div>
  </div>

<script>
/*
  IMPORTANT: put your deployed contract address below (the new one from Remix / Blockscout)
*/
const CONFIG_CONTRACT_ADDRESS = "0xd0999A9A52270B59c341b4d87ee8c22c9633306E";

// ------------ ABI (use the ABI you provided) --------------
// I pasted the ABI you earlier shared. If your contract differs, replace ABI variable with the real ABI JSON.
const ABI = [
  {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
  {"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"address","name":"owner","type":"address"}],"name":"ERC721IncorrectOwner","type":"error"},
  {"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ERC721InsufficientApproval","type":"error"},
  {"inputs":[{"internalType":"address","name":"approver","type":"address"}],"name":"ERC721InvalidApprover","type":"error"},
  {"inputs":[{"internalType":"address","name":"operator","type":"address"}],"name":"ERC721InvalidOperator","type":"error"},
  {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"ERC721InvalidOwner","type":"error"},
  {"inputs":[{"internalType":"address","name":"receiver","type":"address"}],"name":"ERC721InvalidReceiver","type":"error"},
  {"inputs":[{"internalType":"address","name":"sender","type":"address"}],"name":"ERC721InvalidSender","type":"error"},
  {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ERC721NonexistentToken","type":"error"},
  {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},
  {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"_fromTokenId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"_toTokenId","type":"uint256"}],"name":"BatchMetadataUpdate","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"_tokenId","type":"uint256"}],"name":"MetadataUpdate","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},
  {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"badgeData","outputs":[{"internalType":"string","name":"fid","type":"string"},{"internalType":"string","name":"badgeType","type":"string"},{"internalType":"uint64","name":"date","type":"uint64"},{"internalType":"uint32","name":"streak","type":"uint32"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"lastMintTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"string","name":"fid","type":"string"},{"internalType":"string","name":"badgeType_","type":"string"},{"internalType":"uint64","name":"date","type":"uint64"},{"internalType":"uint32","name":"streak","type":"uint32"},{"internalType":"string","name":"tokenURI_","type":"string"}],"name":"mintBadge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"string","name":"fid","type":"string"},{"internalType":"uint32","name":"weekNumber","type":"uint32"},{"internalType":"uint64","name":"date","type":"uint64"},{"internalType":"uint32","name":"streak","type":"uint32"},{"internalType":"string","name":"tokenURI_","type":"string"}],"name":"mintWeekBadge","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"nextTokenId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"weekBadgeData","outputs":[{"internalType":"string","name":"fid","type":"string"},{"internalType":"uint32","name":"weekNumber","type":"uint32"},{"internalType":"uint64","name":"date","type":"uint64"},{"internalType":"uint32","name":"streak","type":"uint32"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"weeksMinted","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"}
];
// ---------------------------------------------------------

// DOM
const connectBtn = document.getElementById('connectBtn');
const refreshBtn = document.getElementById('refreshBtn');
const claimLocalBtn = document.getElementById('claimLocalBtn');
const mintDailyBtn = document.getElementById('mintDailyBtn');
const mintWeekBtn = document.getElementById('mintWeekBtn');
const fidInput = document.getElementById('fidInput');
const statusEl = document.getElementById('status');
const alertEl = document.getElementById('alert');
const okEl = document.getElementById('ok');
const previewText = document.getElementById('previewText');
const streakInfo = document.getElementById('streakInfo');
const accountArea = document.getElementById('accountArea');

let provider = null;
let signer = null;
let contract = null;
let userAddress = null;

// helper: human time
function nowSeconds() { return Math.floor(Date.now()/1000); }
function showAlert(msg){ alertEl.textContent = msg; okEl.textContent = ''; console.warn(msg); }
function showOk(msg){ okEl.textContent = msg; alertEl.textContent = ''; console.log(msg); }
function clearMsgs(){ alertEl.textContent = ''; okEl.textContent = ''; }

async function init() {
  // ensure ethers is loaded
  if(typeof window.ethers === 'undefined') {
    showAlert('Ethers library missing or incompatible. Check console.');
    console.error('Ethers not found on window (ethers UMD required).');
    return;
  }
  statusEl.textContent = `UI ready. CONFIG_CONTRACT_ADDRESS: ${CONFIG_CONTRACT_ADDRESS}`;
  // if contract address not set, warn
  if(!CONFIG_CONTRACT_ADDRESS || CONFIG_CONTRACT_ADDRESS.includes('REPLACE')) {
    showAlert('Please set CONFIG_CONTRACT_ADDRESS in the code to your deployed contract address.');
  }
  // try to create read-only provider if window.ethereum exists
  if(window.ethereum) {
    provider = new ethers.providers.Web3Provider(window.ethereum);
    // instantiate contract read-only (will be connected with provider)
    try {
      contract = new ethers.Contract(CONFIG_CONTRACT_ADDRESS, ABI, provider);
      console.log('Contract (readonly) set.');
    } catch(e) {
      console.error('Contract create failed', e);
      showAlert('Contract create failed â€” check ABI/address in code. See console.');
    }
  } else {
    showAlert('MetaMask (or any injected provider) not found. Connect wallet will fail until provider is available.');
  }
}

// Connect wallet
async function connectWallet() {
  clearMsgs();
  if(!window.ethereum) {
    showAlert('Ethereum provider not found in browser (MetaMask).');
    return;
  }
  try {
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    accountArea.textContent = userAddress;
    showOk('Wallet connected: ' + userAddress);
    // attach signer to contract for write ops
    contract = new ethers.Contract(CONFIG_CONTRACT_ADDRESS, ABI, signer);
    console.log('Contract attached (signer).');
    await refresh(); // show current state
  } catch(err) {
    console.error('connectWallet error', err);
    showAlert('Connect wallet cancelled or failed. See console.');
  }
}

// Refresh UI/data from chain
async function refresh() {
  clearMsgs();
  // show local preview
  const fid = (fidInput.value || '').trim() || 'anon';
  previewText.textContent = `#${fid} Daily Check-in badge earned`;
  try {
    if(!contract || !provider) {
      streakInfo.textContent = `Streak: - | Last claim: - (not connected)`;
      return;
    }
    // call contract.lastMintTime
    if(userAddress) {
      let last = await contract.lastMintTime(userAddress);
      // last is BigNumber seconds
      const lastSec = last ? last.toNumber() : 0;
      const lastStr = lastSec ? new Date(lastSec*1000).toLocaleString() : '-';
      // We can't compute streak reliably on-chain unless you implement a getter; show lastMintTime
      streakInfo.textContent = `Last onchain mint: ${lastStr}`;
    } else {
      streakInfo.textContent = `Streak: local | Last claim: local`;
    }
  } catch(e) {
    console.error('refresh error', e);
    showAlert('Refresh failed: ' + (e && e.message ? e.message : e));
  }
}

// Local claim (store in localStorage)
function claimLocal() {
  clearMsgs();
  const fid = (fidInput.value || '').trim();
  if(!fid) { showAlert('Enter a FID/name first'); return; }
  const key = 'badgehub_claim_' + fid;
  const now = nowSeconds();
  const last = parseInt(localStorage.getItem(key) || '0', 10);
  if(last && (now - last) < 24*3600) {
    showAlert('Already claimed locally within last 24 hours.');
    return;
  }
  localStorage.setItem(key, String(now));
  showOk('Badge claimed locally. (This does not mint onchain.)');
  refreshPreviewLocal(fid, now);
}
function refreshPreviewLocal(fid, when) {
  previewText.textContent = `#${fid} Daily Check-in badge earned (local)`;
  streakInfo.textContent = `Last local claim: ${new Date(when*1000).toLocaleString()}`;
}

// Mint daily badge onchain
async function mintDailyOnchain() {
  clearMsgs();
  if(!contract || !signer) {
    showAlert('Wallet not connected or contract not initialized.');
    return;
  }
  const fid = (fidInput.value || '').trim();
  if(!fid) { showAlert('Enter a FID/name first'); return; }

  try {
    // Prepare parameters for mintBadge: to, fid, badgeType_, date, streak, tokenURI_
    const to = await signer.getAddress();
    const badgeType = "Daily Check-in";
    const date = Math.floor(Date.now()/1000);
    const streak = 1; // if you store streak on-chain, you would compute; for example use 1
    const tokenURI = ""; // optional, empty or your metadata url

    // call contract.mintBadge(to, fid, badgeType, date, streak, tokenURI)
    const tx = await contract.mintBadge(to, fid, badgeType, date, streak, tokenURI);
    showOk('Transaction sent, waiting confirmation: ' + tx.hash);
    const receipt = await tx.wait();
    showOk('Mint successful: ' + receipt.transactionHash);
    await refresh();
  } catch(e) {
    console.error('mintDailyOnchain error', e);
    showAlert('Mint failed: ' + (e && e.message ? e.message : e));
  }
}

// Mint weekly badge onchain (weekNumber param)
async function mintWeeklyOnchain() {
  clearMsgs();
  if(!contract || !signer) {
    showAlert('Wallet not connected or contract not initialized.');
    return;
  }
  const fid = (fidInput.value || '').trim();
  if(!fid) { showAlert('Enter a FID/name first'); return; }

  try {
    const to = await signer.getAddress();
    const weekNumber = 1; // for demo, change as needed
    const date = Math.floor(Date.now()/1000);
    const streak = 7; // example
    const tokenURI = "";

    const tx = await contract.mintWeekBadge(to, fid, weekNumber, date, streak, tokenURI);
    showOk('Weekly mint tx sent: ' + tx.hash);
    const rec = await tx.wait();
    showOk('Weekly mint mined: ' + rec.transactionHash);
    await refresh();
  } catch(e) {
    console.error('mintWeeklyOnchain error', e);
    showAlert('Mint weekly failed: ' + (e && e.message ? e.message : e));
  }
}

// attach events
connectBtn.addEventListener('click', connectWallet);
refreshBtn.addEventListener('click', refresh);
claimLocalBtn.addEventListener('click', claimLocal);
mintDailyBtn.addEventListener('click', mintDailyOnchain);
mintWeekBtn.addEventListener('click', mintWeeklyOnchain);

// initialize UI
init();

</script>
</body>
</html>
