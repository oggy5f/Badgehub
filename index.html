<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Badgehub — 24h Claim (local) — fixed</title>
<style>
  :root{
    --bg:#0f1720; --card:#0b1220; --accent:#ffb347;
    --muted:#9aa6b2; --ok:#2ecc71; --err:#ff6b6b;
    font-family: Inter, system-ui, Arial, sans-serif;
  }
  html,body{height:100%}
  body{ background: linear-gradient(180deg,#071021 0%, #071022 100%); color:#e6eef6; margin:0; padding:24px;}
  .wrap{ max-width:980px; margin:18px auto; display:grid; grid-template-columns:360px 1fr; gap:20px;}
  .card{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; box-shadow:0 6px 20px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03);}
  h1{ margin:0 0 8px 0; font-size:20px; color:var(--accent) }
  label{ display:block; font-size:12px; color:var(--muted); margin-top:12px }
  input[type="text"]{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:inherit; box-sizing:border-box; font-size:14px; }
  input[readonly]{ background:rgba(255,255,255,0.01); color:var(--muted); }
  .btn{ margin-top:12px; display:inline-block; padding:12px 16px; border-radius:12px; cursor:pointer; background:linear-gradient(90deg,#ffb347,#ffcc33); color:#061018; font-weight:600; border:none; box-shadow:0 6px 10px rgba(255,179,71,0.12); }
  .btn.secondary{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04); box-shadow:none; }
  .small { font-size:13px; color:var(--muted); margin-top:8px }
  .msg { margin-top:10px; padding:10px; border-radius:8px; font-size:13px; }
  .msg.ok { background: rgba(46,204,113,0.08); color:var(--ok); border:1px solid rgba(46,204,113,0.06); }
  .msg.err { background: rgba(255,107,107,0.06); color:var(--err); border:1px solid rgba(255,107,107,0.06); }
  .preview{ padding:16px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); min-height:160px; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:12px; text-align:center; }
  .badge{ width:360px; max-width:100%; height:160px; border-radius:12px; background:linear-gradient(90deg,#ffb347,#ffcc33); display:flex; align-items:center; justify-content:center; color:#061018; font-weight:700; font-size:20px; }
  .meta{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
  .pill{ background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:999px; color:var(--muted); font-size:13px; border:1px solid rgba(255,255,255,0.02); }
  pre{ text-align:left; color:var(--muted); background:transparent; overflow:auto; margin:0; font-size:13px; }
  footer { grid-column: 1 / -1; margin-top:14px; color:var(--muted); font-size:13px; text-align:center;}
  @media(max-width:880px){ .wrap{ grid-template-columns: 1fr; } }
</style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <h1>BADGEHUB — Local Claim (24h)</h1>
    <div class="small">Local claim demo. 24-hour rate-limit + streak tracking. (No onchain yet)</div>

    <label for="fid">Your Name / FID</label>
    <input id="fid" type="text" placeholder="enter your FID (e.g. anon)" />

    <label for="badgeType">Badge Type (fixed)</label>
    <!-- readonly so user cannot edit badge type -->
    <input id="badgeType" type="text" value="Daily Check-in" readonly />

    <!-- explicit type="button" prevents form-style submit behavior in some browsers -->
    <button id="claimBtn" type="button" class="btn">Claim today's badge</button>
    <button id="downloadSvg" type="button" class="btn secondary">Download SVG</button>

    <div id="message" class="msg" style="display:none;"></div>

    <div style="margin-top:12px">
      <div class="small">Preview / Status</div>
      <div id="streakInfo" class="small" style="margin-top:8px">Streak: <strong id="streak">0</strong> | Total: <strong id="total">0</strong> | Last claim: <span id="lastClaim">-</span></div>
      <div style="margin-top:8px" class="small">Local storage key: <code id="localKey" style="color:var(--muted)"></code></div>
    </div>
  </div>

  <div class="card preview">
    <div style="width:100%; display:flex; justify-content:space-between; align-items:center">
      <div style="font-size:14px; color:var(--muted)">Badge preview</div>
      <div id="countdown" style="font-size:13px; color:var(--muted)"></div>
    </div>

    <div id="badgeArea" class="badge">— no badge yet —</div>
    <div class="meta">
      <div class="pill" id="pillType">Daily Check-in</div>
      <div class="pill" id="pillDate">-</div>
      <div class="pill" id="pillFid">anon</div>
    </div>

    <pre id="rawPreview" style="margin-top:10px">-</pre>
  </div>

  <footer class="card">Local-only demo. When ready we'll wire onchain mint & verified contract address.</footer>
</div>

<script>
/* --- local claim storage + 24h rate-limit + streak logic --- */

const fidInput = document.getElementById('fid');
const badgeTypeInput = document.getElementById('badgeType');
const claimBtn = document.getElementById('claimBtn');
const downloadBtn = document.getElementById('downloadSvg');
const msgEl = document.getElementById('message');
const badgeArea = document.getElementById('badgeArea');
const pillType = document.getElementById('pillType');
const pillDate = document.getElementById('pillDate');
const pillFid = document.getElementById('pillFid');
const streakEl = document.getElementById('streak');
const totalEl = document.getElementById('total');
const lastClaimEl = document.getElementById('lastClaim');
const rawPreview = document.getElementById('rawPreview');
const localKeyEl = document.getElementById('localKey');
const countdownEl = document.getElementById('countdown');

let countdownTimer = null;

function getLocalKey(fid){
  const safe = (fid || 'anon').trim().replace(/\s+/g,'_').toLowerCase();
  return `badgehub_local_${safe}`;
}

function loadLocal(fid){
  try{
    const key = getLocalKey(fid);
    const raw = localStorage.getItem(key);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ console.error('loadLocal error', e); return null; }
}

function saveLocal(fid, data){
  try{
    const key = getLocalKey(fid);
    localStorage.setItem(key, JSON.stringify(data));
    localKeyEl.textContent = key;
  }catch(e){ console.error('saveLocal error', e); }
}

function nowMs(){ return Date.now(); }
function toIsoDate(ms){
  const d = new Date(ms);
  return d.toISOString().slice(0,10);
}
function fmtDate(ms){
  try{ return new Date(ms).toLocaleString(); }catch(e){ return '-'; }
}

function canClaimNow(fid){
  const rec = loadLocal(fid);
  if(!rec || !rec.lastClaim) return true;
  const elapsed = nowMs() - rec.lastClaim;
  const dayMs = 24 * 60 * 60 * 1000;
  return elapsed >= dayMs;
}
function remainingMsToClaim(fid){
  const rec = loadLocal(fid);
  if(!rec || !rec.lastClaim) return 0;
  const elapsed = nowMs() - rec.lastClaim;
  const dayMs = 24 * 60 * 60 * 1000;
  return Math.max(0, dayMs - elapsed);
}
function msToDHMS(ms){
  const s = Math.floor(ms/1000);
  const d = Math.floor(s/86400); const h = Math.floor((s%86400)/3600);
  const m = Math.floor((s%3600)/60); const sec = s%60;
  if(d>0) return `${d}d ${h}h ${m}m`;
  if(h>0) return `${h}h ${m}m`;
  if(m>0) return `${m}m ${sec}s`;
  return `${sec}s`;
}

function updateUIFor(fid){
  const rec = loadLocal(fid);
  pillFid.textContent = fid || 'anon';
  pillType.textContent = badgeTypeInput.value || 'Daily Check-in';
  if(rec){
    streakEl.textContent = rec.streak || 0;
    totalEl.textContent = rec.total || 0;
    lastClaimEl.textContent = rec.lastClaim ? fmtDate(rec.lastClaim) : '-';
    pillDate.textContent = rec.lastClaim ? toIsoDate(rec.lastClaim) : '-';
    badgeArea.textContent = `${(rec.fid || fid).toUpperCase()} — ${(badgeTypeInput.value || 'Daily Check-in')}`;
    rawPreview.textContent = JSON.stringify(rec, null, 2);
  } else {
    streakEl.textContent = 0;
    totalEl.textContent = 0;
    lastClaimEl.textContent = '-';
    pillDate.textContent = '-';
    badgeArea.textContent = `— no badge yet —`;
    rawPreview.textContent = '-';
  }
  // countdown and claim button state
  if(canClaimNow(fid)){
    claimBtn.disabled = false;
    claimBtn.textContent = 'Claim today\'s badge';
    countdownEl.textContent = '';
    if(countdownTimer){ clearInterval(countdownTimer); countdownTimer = null; }
  } else {
    claimBtn.disabled = true;
    const rem = remainingMsToClaim(fid);
    claimBtn.textContent = 'Already claimed — locked';
    countdownEl.textContent = `Retry in ${msToDHMS(rem)}`;
    if(countdownTimer) clearInterval(countdownTimer);
    countdownTimer = setInterval(()=>{
      const r = remainingMsToClaim(fid);
      countdownEl.textContent = `Retry in ${msToDHMS(r)}`;
      if(r<=0){ clearInterval(countdownTimer); countdownTimer=null; updateUIFor(fid); }
    }, 1000);
  }
}

function showMsg(text, type='ok'){
  console.log('UI message:', type, text);
  msgEl.style.display = 'block';
  msgEl.className = 'msg ' + (type==='ok' ? 'ok' : 'err');
  msgEl.textContent = text;
  setTimeout(()=>{ msgEl.style.display='none'; }, 6000);
}

// keep daily list for weekly logic (not used now but handy)
function addDailyRecord(fid){
  try{
    const key = getLocalKey(fid) + '_days';
    const arr = JSON.parse(localStorage.getItem(key) || '[]');
    const today = toIsoDate(nowMs());
    if(!arr.includes(today)) arr.push(today);
    const trimmed = arr.slice(-30);
    localStorage.setItem(key, JSON.stringify(trimmed));
    return trimmed;
  }catch(e){ console.error('addDailyRecord', e); return []; }
}

function claimNow(){
  try{
    const fid = (fidInput.value || 'anon').trim();
    if(!fid){
      showMsg('Enter a valid FID', 'err'); return;
    }
    if(!canClaimNow(fid)){
      showMsg('You already claimed in the last 24 hours. Wait and try again.', 'err');
      return;
    }
    const prev = loadLocal(fid);
    let newStreak = 1;
    if(prev && prev.lastClaim){
      const gap = nowMs() - prev.lastClaim;
      const twoDays = 48 * 60 * 60 * 1000;
      newStreak = (gap <= twoDays) ? ((prev.streak||0) + 1) : 1;
    }
    const newTotal = (prev ? (prev.total || 0) : 0) + 1;
    const rec = {
      fid,
      lastClaim: nowMs(),
      streak: newStreak,
      total: newTotal
    };
    rec.days = addDailyRecord(fid);
    saveLocal(fid, rec);
    updateUIFor(fid);
    showMsg('Badge claimed. Streak updated.', 'ok');
    console.log('Claim saved:', rec);
  }catch(err){
    console.error('claimNow error', err);
    showMsg('Claim failed (see console)', 'err');
  }
}

claimBtn.addEventListener('click', claimNow);

// update UI when input changes
fidInput.addEventListener('input', ()=>{
  const fid = (fidInput.value || 'anon').trim();
  updateUIFor(fid);
});
badgeTypeInput.addEventListener('input', ()=>{
  // ignore — readonly by design; just reflect
  pillType.textContent = badgeTypeInput.value || 'Daily Check-in';
});

// download SVG
downloadBtn.addEventListener('click', ()=>{
  const fid = (fidInput.value || 'anon').trim();
  const type = badgeTypeInput.value || 'Daily Check-in';
  const date = new Date().toLocaleDateString();
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="900" height="300">
    <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#ffb347"/><stop offset="1" stop-color="#ffcc33"/></linearGradient></defs>
    <rect width="100%" height="100%" rx="16" fill="url(#g)"/>
    <text x="50%" y="45%" font-family="Inter, Arial" font-size="42" text-anchor="middle" fill="#061018">${escapeXml(fid)}</text>
    <text x="50%" y="72%" font-family="Inter, Arial" font-size="22" text-anchor="middle" fill="#061018">${escapeXml(type)} — ${escapeXml(date)}</text>
  </svg>`;
  const blob = new Blob([svg], {type:'image/svg+xml'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `${(fid||'anon')}_badge.svg`; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 200);
});

function escapeXml(s){ return (''+s).replace(/[&<>'"]/g, (c)=>{'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&apos;'}[c]); }

// init
(function init(){
  try{
    const lastUsed = localStorage.getItem('badgehub_last_fid') || '';
    if(lastUsed) fidInput.value = lastUsed;
    const fid = (fidInput.value || 'anon').trim();
    localKeyEl.textContent = getLocalKey(fid);
    updateUIFor(fid);
    console.log('Badgehub UI ready for', fid);
  }catch(e){ console.error('init error', e); }
})();

fidInput.addEventListener('blur', ()=> {
  const v = (fidInput.value || '').trim();
  if(v) localStorage.setItem('badgehub_last_fid', v);
});
</script>

</body>
</html>
