<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Badgehub ‚Äî Daily Check-in (local + onchain)</title>
<style>
  :root{
    --bg:#0b0f12; --card:#0f1720; --accent:#ffb347; --muted:#9aa6b2; --glass: rgba(255,255,255,0.03);
    --btn:#1f6feb; --btn-dark:#0b4db5;
  }
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#050607 0%, #0b0f12 100%);color:#e6eef7}
  .wrap{max-width:980px;margin:36px auto;padding:18px;display:grid;grid-template-columns:360px 1fr;gap:22px}
  .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
  h1{margin:0 0 10px;font-size:20px;color:var(--accent)}
  label{display:block;margin:8px 0 6px;color:var(--muted);font-size:13px}
  input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit}
  .row{display:flex;gap:10px;align-items:center;margin-top:12px}
  button{cursor:pointer;padding:12px 14px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),#ff8a3d);color:#07111a;font-weight:600}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfe2ff;padding:10px 12px}
  .btn-blue{background:linear-gradient(90deg,#2fb1ff,#0f77ff);color:white;padding:10px 12px;border-radius:10px;border:none}
  .muted{color:var(--muted);font-size:13px;margin-top:10px}
  .preview{padding:18px;border-radius:10px;background:linear-gradient(180deg,#081017,#07121a);min-height:170px;color:#fff}
  .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  .green{color:#58d68d}
  small{color:var(--muted)}
  .error{color:#ff7b7b;margin-top:10px}
  .ok{color:#8ff7b3;margin-top:10px}
  .svg-box{background:#061017;border-radius:8px;padding:12px;margin-top:12px}
  footer{grid-column:1/-1;margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  @media(max-width:900px){.wrap{grid-template-columns:1fr;padding:12px}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>BADGEHUB</h1>
      <small class="muted">Daily Check-in (old / local UI)</small>

      <label>Your name / FID</label>
      <input type="text" id="fidInput" placeholder="enter your FID (e.g. anon)" />

      <div class="row">
        <button id="connectBtn" class="btn-blue">Connect Wallet</button>
        <button id="refreshBtn" class="btn-ghost">Refresh</button>
      </div>

      <label style="margin-top:14px">Actions</label>
      <div class="controls">
        <button id="claimLocal" class="btn-ghost">Claim Today's Badge (local)</button>
        <button id="mintOnchain" class="btn-blue">Mint Daily Badge Onchain</button>
        <button id="mintWeekOnchain" class="btn-blue">Mint Weekly Badge Onchain</button>
      </div>

      <label style="margin-top:14px">Share & utilities</label>
      <div class="controls">
        <button id="shareX" class="btn-ghost">Share on X</button>
        <button id="shareFarcaster" class="btn-ghost">Share on Farcaster</button>
        <button id="copyCaption" class="btn-ghost">Copy caption</button>
        <button id="downloadSvg" class="btn-ghost">Download SVG</button>
      </div>

      <div id="uiStatus" class="muted" style="margin-top:12px">UI ready.</div>
      <div id="messageArea" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="preview">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div id="previewName" style="font-weight:700;font-size:18px">-</div>
            <div style="color:var(--muted);font-size:13px">Daily Check-In ¬∑ Streak: <span id="streakVal">0</span></div>
          </div>
          <div style="min-width:140px;text-align:right">
            <div style="font-size:12px;color:var(--muted)">Badge preview</div>
            <div id="badgeCard" style="margin-top:10px;border-radius:8px;padding:8px;background:linear-gradient(90deg,#ffb347,#ff8a3d);color:#07111a">
              <div id="svgPreview">üê∏</div>
              <div id="previewFid" style="margin-top:8px;font-weight:700">-</div>
            </div>
          </div>
        </div>

        <div class="svg-box" id="captionPreview" style="margin-top:14px">
          <div style="color:var(--muted)">Caption preview</div>
          <pre id="captionText" style="white-space:pre-wrap;margin-top:8px;color:#e6f1ff">-</pre>
        </div>
      </div>
      <div class="muted" style="margin-top:12px">Tip: "local" claim stores data in your browser. Onchain mint will call the smart contract (if configured).</div>
    </div>

    <footer class="muted">Badgehub ‚Äî local test UI. Replace contract address & ABI in script before onchain mints.</footer>
  </div>

<script>
/*
  IMPORTANT CONFIG - replace before using onchain mints:
*/
const CONFIG_CHAIN_NAME = 'Base Sepolia'; // just informative
const CONFIG_CONTRACT_ADDRESS = "0xREPLACE_WITH_YOUR_CONTRACT_ADDRESS"; // <--- put your deployed contract here (0x...)
const ABI = [ /* <-- replace with your contract ABI JSON if you want onchain call to work */ ];

// ---- runtime state
let provider = null;       // ethers provider wrapper (if loaded)
let signer = null;
let contract = null;
let userAddress = null;
let ethersLoaded = false;

// Utility: load ethers UMD if not present
async function ensureEthers() {
  if (window.ethers) { ethersLoaded = true; return; }
  // try to load CDN
  const cdn = "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js";
  try {
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = cdn;
      s.onload = () => resolve();
      s.onerror = () => reject(new Error('CDN load failed'));
      document.head.appendChild(s);
    });
    if (window.ethers) { ethersLoaded = true; console.log('ethers loaded from CDN'); return; }
  } catch(e) {
    console.warn('Failed to load ethers from CDN:', e);
  }
  // fallback: not loaded
  ethersLoaded = false;
  console.warn('ethers is not defined. Provide ethers.umd.min.js via CDN or host locally as /libs/ethers.umd.min.js');
}

// Simple UI helpers
const $ = id => document.getElementById(id);
function showMsg(text, cls='') {
  const el = $("messageArea");
  el.innerHTML = `<div class="${cls}">${text}</div>`;
}

// Compose caption
function buildCaption(fid, streak) {
  return `#${fid} Daily Check-in badge earned\n\nStreak: ${streak} | Total: ${streak}\n#Badgehub #Base`;
}

// SVG generator (basic)
function generateSVG(name, color='#ffb347') {
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='600' height='340'>
  <rect rx='20' width='100%' height='100%' fill='${color}'/>
  <text x='50%' y='60%' font-size='40' text-anchor='middle' font-family='Arial' fill='#07111a'>${escapeHtml(name)}</text>
  </svg>`;
  return svg;
}
function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// Local claim storage
function getLocalKey(fid) { return `badgehub_local_${fid}`; }
function claimLocal(fid) {
  if(!fid) { showMsg('Enter your FID first', 'error'); return; }
  const key = getLocalKey(fid);
  const now = Date.now();
  const data = { fid, lastClaim: now, streak: 1, total: 1 }; // simple demo logic
  localStorage.setItem(key, JSON.stringify(data));
  updatePreview(fid, data);
  showMsg('Badge claimed. Streak updated.', 'ok');
}

// Load local data
function loadLocal(fid) {
  const key = getLocalKey(fid);
  const s = localStorage.getItem(key);
  if(!s) return null;
  try { return JSON.parse(s); } catch(e){ return null; }
}

// Update preview
function updatePreview(fid, data) {
  $('previewName').innerText = fid || '-';
  $('previewFid').innerText = fid || '-';
  $('streakVal').innerText = (data && data.streak) ? data.streak : 0;
  const caption = buildCaption(fid || 'anon', (data && data.streak) ? data.streak : 0);
  $('captionText').innerText = caption;
  $('svgPreview').innerHTML = ""; // show svg as text
  // set colored card
  const svg = generateSVG(fid || 'anon');
  $('badgeCard').querySelector('#svgPreview').innerHTML = '';
  // For simplicity show name
  $('badgeCard').querySelector('#svgPreview').textContent = 'Badge';
}

// Connect wallet
async function connectWallet() {
  try {
    if(!window.ethereum) {
      showMsg('No wallet extension detected (MetaMask).', 'error');
      return;
    }
    // Ensure ethers lib available
    await ensureEthers();

    // Standard request
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' }).catch(e=>{throw e;});
    if(!accounts || accounts.length===0) {
      showMsg('Connect canceled or no accounts available.', 'error');
      return;
    }
    userAddress = accounts[0];
    $('connectBtn').innerText = shorten(userAddress);
    showMsg('Connected: ' + userAddress, 'ok');

    // create ethers provider if loaded
    if(window.ethers) {
      provider = new window.ethers.providers.Web3Provider(window.ethereum, "any");
      signer = provider.getSigner();
      // attach contract if address + ABI provided
      if(CONFIG_CONTRACT_ADDRESS && CONFIG_CONTRACT_ADDRESS.startsWith('0x') && ABI && ABI.length>0) {
        try {
          contract = new window.ethers.Contract(CONFIG_CONTRACT_ADDRESS, ABI, signer);
          console.log('Contract initialized', contract.address);
        } catch(e) {
          console.warn('Contract init error', e);
        }
      } else {
        contract = null;
      }
    } else {
      provider = null;
      signer = null;
      contract = null;
      console.warn('ethers not loaded: onchain actions disabled.');
    }

    // initial UI refresh
    refreshUI();
  } catch(err) {
    console.error('connectWallet err', err);
    showMsg('Connect failed: ' + (err.message || err), 'error');
  }
}

// Mint onchain (daily)
async function mintOnchainHandler() {
  if(!userAddress) { showMsg('Connect wallet first.', 'error'); return; }
  if(!contract) { showMsg('Contract or ABI missing ‚Äî onchain disabled. Fill CONFIG_CONTRACT_ADDRESS & ABI in script.', 'error'); return; }
  try {
    // simple example payload ‚Äî update according to your contract
    const fid = $('fidInput').value || 'anon';
    const date = Math.floor(Date.now()/1000);
    const streak = (loadLocal(fid) && loadLocal(fid).streak) ? loadLocal(fid).streak : 1;
    const tokenURI = ''; // optional
    showMsg('Sending onchain mint tx...', '');
    const tx = await contract.mintBadge(userAddress, fid, "Daily Check-in", date, streak, tokenURI);
    showMsg('Transaction sent. Waiting for confirmation...', '');
    await tx.wait();
    showMsg('Badge minted onchain ‚úÖ Tx: ' + tx.hash, 'ok');
  } catch(e) {
    console.error('mintOnchain err', e);
    showMsg('Onchain mint failed: ' + (e && e.message ? e.message : e), 'error');
  }
}

// Mint week onchain (example)
async function mintWeekHandler() {
  if(!userAddress) { showMsg('Connect wallet first.', 'error'); return; }
  if(!contract) { showMsg('Contract or ABI missing ‚Äî onchain disabled.', 'error'); return; }
  try {
    const fid = $('fidInput').value || 'anon';
    const weekNumber = 1; // customize
    const date = Math.floor(Date.now()/1000);
    const streak = (loadLocal(fid) && loadLocal(fid).streak) ? loadLocal(fid).streak : 7;
    const tokenURI = '';
    const tx = await contract.mintWeekBadge(userAddress, fid, weekNumber, date, streak, tokenURI);
    showMsg('Mint week tx sent. waiting...', '');
    await tx.wait();
    showMsg('Weekly badge minted onchain ‚úÖ Tx: ' + tx.hash, 'ok');
  } catch(e) {
    console.error('mintWeek err', e);
    showMsg('Weekly onchain mint failed: ' + (e && e.message ? e.message : e), 'error');
  }
}

// Share to X (Twitter)
function shareToX(caption) {
  const url = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(caption);
  window.open(url, '_blank');
}

// Share to Farcaster (mobile deep link + warpcast fallback + system share + clipboard)
async function shareToFarcaster(caption) {
  // 1) open warpcast web compose (works on desktop & mobile)
  const webCompose = `https://warpcast.com/~/compose?text=${encodeURIComponent(caption)}`;
  window.open(webCompose, '_blank');

  // 2) attempt deep link (mobile)
  const deepLinks = [
    `farcaster://cast?text=${encodeURIComponent(caption)}`,
    `farcaster://compose?text=${encodeURIComponent(caption)}`
  ];
  // fire with small delays
  deepLinks.forEach((u, i) => setTimeout(()=>{ window.open(u); }, 200 + i*150));

  // 3) system share if available
  if(navigator.share) {
    try {
      await navigator.share({ text: caption });
      return;
    } catch(e){ /* user canceled */ }
  }

  // 4) clipboard fallback
  try {
    await navigator.clipboard.writeText(caption);
    alert('Caption copied to clipboard. Paste it in Farcaster.');
  } catch(e) {
    window.prompt('Copy this caption', caption);
  }
}

// Copy caption
async function copyCaption() {
  const caption = $('captionText').innerText;
  try {
    await navigator.clipboard.writeText(caption);
    showMsg('Caption copied to clipboard.', 'ok');
  } catch(e) {
    window.prompt('Copy this caption', caption);
  }
}

// Download SVG
function downloadSVG() {
  const fid = $('fidInput').value || 'anon';
  const svg = generateSVG(fid);
  const blob = new Blob([svg], {type:'image/svg+xml'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${fid}_badge.svg`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// simple refresh UI
function refreshUI() {
  const fid = $('fidInput').value || 'anon';
  const data = loadLocal(fid);
  updatePreview(fid, data);
}

// helpers
function shorten(address) {
  if(!address) return '';
  return address.slice(0,6) + '...' + address.slice(-4);
}

// wiring
document.getElementById('connectBtn').addEventListener('click', connectWallet);
document.getElementById('refreshBtn').addEventListener('click', refreshUI);
document.getElementById('claimLocal').addEventListener('click', ()=> {
  const fid = $('fidInput').value || 'anon';
  claimLocal(fid);
});
document.getElementById('mintOnchain').addEventListener('click', mintOnchainHandler);
document.getElementById('mintWeekOnchain').addEventListener('click', mintWeekHandler);
document.getElementById('shareX').addEventListener('click', ()=> shareToX($('captionText').innerText));
document.getElementById('shareFarcaster').addEventListener('click', ()=> shareToFarcaster($('captionText').innerText));
document.getElementById('copyCaption').addEventListener('click', copyCaption);
document.getElementById('downloadSvg').addEventListener('click', downloadSVG);
document.getElementById('fidInput').addEventListener('input', ()=> { $('previewName').innerText = $('fidInput').value || '-'; });

// init on load
(async function init() {
  $('uiStatus').innerText = `UI ready. CONFIG_CONTRACT_ADDRESS: ${CONFIG_CONTRACT_ADDRESS}`;
  await ensureEthers();
  if(!window.ethers) {
    showMsg('ethers is not defined. Make sure CDN is allowed or host ethers locally as /libs/ethers.umd.min.js', 'error');
    console.warn('ethers missing: onchain features disabled until you include the UMD script (see console).');
  }
  refreshUI();

  // auto detect account if previously connected
  if(window.ethereum) {
    try {
      const accounts = await window.ethereum.request({ method: 'eth_accounts' }).catch(()=>[]);
      if(accounts && accounts.length>0) {
        userAddress = accounts[0];
        $('connectBtn').innerText = shorten(userAddress);
        // create provider if ethers loaded
        if(window.ethers) {
          provider = new window.ethers.providers.Web3Provider(window.ethereum, "any");
          signer = provider.getSigner();
          if(CONFIG_CONTRACT_ADDRESS && CONFIG_CONTRACT_ADDRESS.startsWith('0x') && ABI && ABI.length>0) {
            contract = new window.ethers.Contract(CONFIG_CONTRACT_ADDRESS, ABI, signer);
            console.log('Contract auto-init', contract.address);
          }
        }
      }
    } catch(e){}
  }
})();
</script>
</body>
</html>
