<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Badgehub - connect debug</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial; background:#07121a; color:#e6fff6; padding:24px; }
    .container{max-width:900px;margin:0 auto}
    input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #28474f;background:#0b2a31;color:#fff}
    button{padding:10px 16px;border-radius:10px;border:0;margin:6px;background:#0b82b7;color:#fff;cursor:pointer}
    button.secondary{background:#3b3b3b}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .status{margin-top:12px;padding:10px;border-radius:8px}
    .ok{background:#062d12;color:#a9f7b8}
    .err{background:#3b0b0b;color:#ffb4b4}
    .muted{color:#aac7cd}
  </style>
</head>
<body>
  <div class="container">
    <h1>Badgehub - debug loader</h1>

    <label>Your FID / name</label>
    <input id="fidInput" placeholder="enter your FID (e.g. anon)" />

    <div class="row">
      <button id="connectBtn">Connect Wallet</button>
      <button id="refreshBtn" class="secondary">Refresh</button>
    </div>

    <div class="row">
      <button id="claimLocalBtn" class="secondary">Claim Today's Badge (local)</button>
      <button id="mintDailyBtn">Mint Daily Badge Onchain</button>
      <button id="mintWeeklyBtn">Mint Weekly Badge Onchain</button>
    </div>

    <div id="uiStatus" class="status muted">UI initializing...</div>

  </div>

<script>
/*
  Drop-in debug page:
  - dynamically loads ethers.js then runs appInit()
  - shows clearer console messages
  - replace CONFIG_CONTRACT_ADDRESS below with your contract if needed
*/

const CONFIG_CONTRACT_ADDRESS = "0xd0999A9A52270B59c341b4d87ee8c22c9633306"; // change if needed

const uiStatus = document.getElementById('uiStatus');
const connectBtn = document.getElementById('connectBtn');
const refreshBtn = document.getElementById('refreshBtn');
const claimLocalBtn = document.getElementById('claimLocalBtn');
const mintDailyBtn = document.getElementById('mintDailyBtn');
const mintWeeklyBtn = document.getElementById('mintWeeklyBtn');
const fidInput = document.getElementById('fidInput');

function setStatus(msg, type='muted') {
  uiStatus.className = 'status';
  if (type === 'ok') uiStatus.classList.add('ok');
  else if (type === 'err') uiStatus.classList.add('err');
  else uiStatus.classList.add('muted');
  uiStatus.textContent = msg;
  console.log('[UI STATUS]', msg);
}

// helper to load script and return a promise
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = () => resolve();
    s.onerror = (e) => reject(new Error('Failed to load ' + src));
    document.head.appendChild(s);
  });
}

// try to load ethers if not present
async function ensureEthers() {
  if (window.ethers) {
    console.log('ethers already present');
    return;
  }
  try {
    // try CDN (v5)
    await loadScript('https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js');
    if (!window.ethers) throw new Error('ethers did not become available after load');
    console.log('ethers loaded from CDN');
  } catch (err) {
    console.error('Failed to load ethers from CDN', err);
    throw err;
  }
}

// check for wallet injection conflicts
function detectWalletConflicts() {
  // Brave has window.ethereum but also sets a provider that can cause errors.
  // We can't programmatically disable Brave wallet, but we can show a helpful message.
  if (!window.ethereum) {
    setStatus('No wallet detected (window.ethereum missing) — install MetaMask.', 'err');
    return false;
  }
  // detect Brave's provider meta: Brave sets isBraveWallet or similar. MetaMask sets isMetaMask = true.
  if (window.ethereum.isBraveWallet && !window.ethereum.isMetaMask) {
    setStatus('Brave Wallet detected and may block MetaMask. Disable Brave Wallet or enable MetaMask.', 'err');
    return false;
  }
  return true;
}

let provider = null;
let signer = null;
let contract = null; // later

async function appInit() {
  try {
    await ensureEthers();
  } catch (err) {
    setStatus('ethers is not defined. Make sure internet allows CDN or host ethers locally.', 'err');
    return;
  }

  // basic sanity
  setStatus('ethers loaded. CONFIG_CONTRACT_ADDRESS: ' + CONFIG_CONTRACT_ADDRESS, 'ok');

  // detect wallet conflict
  if (!detectWalletConflicts()) {
    console.warn('wallet conflict, user should fix extension settings.');
  }

  // create a read provider if a wallet exists
  if (window.ethereum) {
    try {
      provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
      console.log('created Web3Provider');
    } catch (err) {
      console.error('Could not create Web3Provider', err);
      setStatus('Error creating provider: ' + (err.message||err), 'err');
      return;
    }
  } else {
    setStatus('No wallet extension found — local tests only.', 'err');
  }

  // attach simple handlers
  connectBtn.onclick = async () => {
    try {
      if (!provider) {
        setStatus('No provider. Install MetaMask and reload.', 'err');
        return;
      }
      // request
      await provider.send('eth_requestAccounts', []);
      signer = provider.getSigner();
      const address = await signer.getAddress();
      setStatus('Connected: ' + address, 'ok');

      // now create contract with signer for writes (if you have ABI later)
      // contract = new ethers.Contract(CONFIG_CONTRACT_ADDRESS, ABI, signer);
      console.log('connected address', address);
    } catch (err) {
      console.error('connect error', err);
      setStatus('Connect failed: ' + (err && err.message), 'err');
    }
  };

  refreshBtn.onclick = () => {
    setStatus('Refreshed UI info', 'ok');
    console.log('refresh clicked');
  };

  claimLocalBtn.onclick = () => {
    const fid = (fidInput.value || 'anon').trim();
    const key = 'badgehub_local_claim_' + fid;
    localStorage.setItem(key, JSON.stringify({ date: Date.now(), streak: 1 }));
    setStatus('Claim saved to localStorage for ' + fid, 'ok');
  };

  mintDailyBtn.onclick = () => {
    setStatus('Mint click pressed — must connect and have ABI/contract. See console.', 'muted');
    console.log('mintDaily clicked — not wired in debug page');
  };

  mintWeeklyBtn.onclick = () => {
    setStatus('Mint week click pressed — must connect and have ABI/contract. See console.', 'muted');
    console.log('mintWeekly clicked — not wired in debug page');
  };

  setStatus('Ready. Try Connect Wallet. If connect fails see console logs.', 'ok');
}

// run init on load
window.addEventListener('load', () => {
  appInit().catch(e => {
    console.error('appInit error', e);
    setStatus('Initialization error: ' + (e && e.message), 'err');
  });
});

</script>
</body>
</html>
