<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Badgehub - connect debug (CDN fallback)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial; background:#07121a; color:#e6fff6; padding:22px; }
    .container{max-width:900px;margin:0 auto}
    input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid #28474f;background:#0b2a31;color:#fff}
    button{padding:10px 16px;border-radius:10px;border:0;margin:6px;background:#0b82b7;color:#fff;cursor:pointer}
    button.secondary{background:#3b3b3b}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .status{margin-top:12px;padding:10px;border-radius:8px}
    .ok{background:#062d12;color:#a9f7b8}
    .err{background:#3b0b0b;color:#ffb4b4}
    .muted{color:#aac7cd}
    small.muted{color:#aac7cd;display:block;margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Badgehub - debug loader (CDN fallback)</h1>

    <label>Your FID / name</label>
    <input id="fidInput" placeholder="enter your FID (e.g. anon)" />

    <div class="row">
      <button id="connectBtn">Connect Wallet</button>
      <button id="refreshBtn" class="secondary">Refresh</button>
    </div>

    <div class="row">
      <button id="claimLocalBtn" class="secondary">Claim Today's Badge (local)</button>
      <button id="mintDailyBtn">Mint Daily Badge Onchain</button>
      <button id="mintWeeklyBtn">Mint Weekly Badge Onchain</button>
    </div>

    <div id="uiStatus" class="status muted">UI initializing...</div>

    <small class="muted">If you see "ethers is not defined" — CDN blocked. Download ethers.umd.min.js and put it in <code>/libs/ethers.umd.min.js</code>.</small>
  </div>

<script>
/* CONFIG: change if needed */
const CONFIG_CONTRACT_ADDRESS = "0xd0999A9A52270B59c341b4d87ee8c22c9633306";

/* UI helpers */
const uiStatus = document.getElementById('uiStatus');
const connectBtn = document.getElementById('connectBtn');
const refreshBtn = document.getElementById('refreshBtn');
const claimLocalBtn = document.getElementById('claimLocalBtn');
const mintDailyBtn = document.getElementById('mintDailyBtn');
const mintWeeklyBtn = document.getElementById('mintWeeklyBtn');
const fidInput = document.getElementById('fidInput');

function setStatus(msg, type='muted') {
  uiStatus.className = 'status';
  if (type === 'ok') uiStatus.classList.add('ok');
  else if (type === 'err') uiStatus.classList.add('err');
  else uiStatus.classList.add('muted');
  uiStatus.textContent = msg;
  console.log('[UI STATUS]', msg);
}

/* try-lists for CDN/UMD builds */
const CDN_UMD_URLS = [
  'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js',
  'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js'
];

function loadScriptUrl(url) {
  return new Promise((resolve, reject) => {
    console.log('Attempting to load script:', url);
    const s = document.createElement('script');
    s.src = url;
    s.async = true;
    s.onload = () => {
      console.log('Loaded script', url);
      resolve(url);
    };
    s.onerror = (e) => {
      console.warn('Failed load', url, e);
      reject(new Error('Failed to load ' + url));
    };
    document.head.appendChild(s);
  });
}

/* try multiple CDNs then fallback to local file */
async function ensureEthersWithFallback() {
  if (window.ethers) {
    console.log('ethers already present');
    return;
  }
  // try CDN URLs sequentially
  for (const url of CDN_UMD_URLS) {
    try {
      await loadScriptUrl(url);
      if (window.ethers) {
        console.log('ethers ready from', url);
        return;
      }
    } catch (e) {
      console.warn('cdn attempt failed', url);
    }
  }
  // last fallback: local file path (you must place this in repo: libs/ethers.umd.min.js)
  const local = '/libs/ethers.umd.min.js';
  try {
    await loadScriptUrl(local);
    if (window.ethers) {
      console.log('ethers loaded from local', local);
      return;
    }
  } catch (err) {
    console.error('local fallback failed', err);
    throw new Error('All attempts to load ethers failed. Please add /libs/ethers.umd.min.js or allow CDN.');
  }
}

/* wallet conflict detect */
function detectWalletConflicts() {
  if (!window.ethereum) {
    setStatus('No wallet detected (window.ethereum missing) — install MetaMask.', 'err');
    return false;
  }
  if (window.ethereum.isBraveWallet && !window.ethereum.isMetaMask) {
    setStatus('Brave Wallet detected and may block MetaMask. Disable Brave Wallet or enable MetaMask.', 'err');
    return false;
  }
  return true;
}

/* minimal app init */
let provider = null;
let signer = null;

async function appInit() {
  try {
    await ensureEthersWithFallback();
  } catch (err) {
    console.error(err);
    setStatus('ethers is not defined. Make sure CDN allowed or host /libs/ethers.umd.min.js', 'err');
    return;
  }

  setStatus('ethers loaded. CONFIG_CONTRACT_ADDRESS: ' + CONFIG_CONTRACT_ADDRESS, 'ok');

  if (!detectWalletConflicts()) {
    console.warn('wallet conflict');
  }

  if (window.ethereum) {
    try {
      provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
      console.log('provider created');
    } catch (err) {
      console.error('provider error', err);
      setStatus('Error creating provider: ' + err.message, 'err');
      return;
    }
  } else {
    setStatus('No wallet extension found — local tests only.', 'err');
  }

  connectBtn.onclick = async () => {
    try {
      if (!provider) {
        setStatus('No provider. Install MetaMask and reload.', 'err');
        return;
      }
      await provider.send('eth_requestAccounts', []);
      signer = provider.getSigner();
      const addr = await signer.getAddress();
      setStatus('Connected: ' + addr, 'ok');
      console.log('connected address', addr);
      // If you want to create a contract instance for writes, load ABI and do:
      // contract = new ethers.Contract(CONFIG_CONTRACT_ADDRESS, ABI, signer);
    } catch (err) {
      console.error('connect error', err);
      setStatus('Connect failed: ' + (err.message||err), 'err');
    }
  };

  refreshBtn.onclick = () => {
    setStatus('Refreshed UI info', 'ok');
    console.log('refresh clicked');
  };

  claimLocalBtn.onclick = () => {
    const fid = (fidInput.value || 'anon').trim();
    const key = 'badgehub_local_claim_' + fid;
    localStorage.setItem(key, JSON.stringify({ date: Date.now(), streak: 1 }));
    setStatus('Claim saved to localStorage for ' + fid, 'ok');
  };

  mintDailyBtn.onclick = () => {
    setStatus('Mint button pressed — connect + ABI required. See console.', 'muted');
    console.log('mintDaily clicked');
  };

  mintWeeklyBtn.onclick = () => {
    setStatus('Mint weekly pressed — connect + ABI required. See console.', 'muted');
    console.log('mintWeekly clicked');
  };

  setStatus('Ready. Try Connect Wallet. Check console/network for script loads.', 'ok');
}

/* run init */
window.addEventListener('load', () => {
  appInit().catch(e => {
    console.error('appInit error', e);
    setStatus('Initialization error: ' + (e.message||e), 'err');
  });
});

</script>
</body>
</html>
