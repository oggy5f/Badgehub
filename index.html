<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Badgehub — DEBUG claim button</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#07101a;color:#e9f0f6;margin:20px}
  .box{max-width:820px;margin:0 auto;display:flex;gap:20px;flex-wrap:wrap}
  .panel{background:#0b1320;padding:18px;border-radius:10px;flex:1;min-width:300px}
  h2{color:#ffb347;margin:0 0 12px 0}
  label{display:block;color:#9fb0bf;margin-top:8px;font-size:13px}
  input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.01);color:inherit}
  button{margin-top:12px;padding:10px 14px;border-radius:10px;border:none;cursor:pointer}
  .claim{background:linear-gradient(90deg,#ffb347,#ffcc33);color:#071018;font-weight:700}
  .msg{margin-top:12px;padding:10px;border-radius:8px;display:none}
  .ok{background:rgba(46,204,113,0.08);color:#2ecc71}
  .err{background:rgba(255,107,107,0.06);color:#ff6b6b}
  .preview{background:rgba(255,255,255,0.01);padding:10px;border-radius:8px;margin-top:10px}
  .small{color:#9fb0bf;font-size:13px}
  pre{background:transparent;color:#9fb0bf;white-space:pre-wrap}
</style>
</head>
<body>
  <div class="box">
    <div class="panel">
      <h2>Badgehub — Local Claim (debug)</h2>

      <label for="fid">Your FID / name</label>
      <input id="fid" type="text" placeholder="enter your FID (e.g. anon)" value="anon"/>

      <label for="badge">Badge type (fixed)</label>
      <input id="badge" type="text" value="Daily Check-in" readonly/>

      <button id="claimBtn" class="claim" type="button">Claim today's badge</button>
      <div id="msg" class="msg"></div>

      <div class="small" style="margin-top:8px">Status / local key</div>
      <div class="small" id="localKey"></div>

      <div class="preview">
        <div class="small">Preview</div>
        <div id="badgeArea" style="margin-top:8px;padding:12px;border-radius:8px;background:#112233;color:#fff;text-align:center">
          — no badge yet —
        </div>
        <div style="margin-top:8px" class="small">
          Streak: <strong id="streak">0</strong> | Total: <strong id="total">0</strong> | Last claim: <span id="last">-</span>
        </div>
        <pre id="raw">-</pre>
      </div>
    </div>

    <div class="panel">
      <h2>Debug console logs</h2>
      <div class="small">Open browser DevTools → Console to see logs. If claim fails paste the console output here.</div>
      <pre id="log" style="height:360px;overflow:auto;"></pre>
    </div>
  </div>

<script>
/* Minimal working local-only claim with 24h lock. Lots of logs to help debug. */

const claimBtn = document.getElementById('claimBtn');
const fidInput = document.getElementById('fid');
const badgeInput = document.getElementById('badge');
const msg = document.getElementById('msg');
const badgeArea = document.getElementById('badgeArea');
const raw = document.getElementById('raw');
const streakEl = document.getElementById('streak');
const totalEl = document.getElementById('total');
const lastEl = document.getElementById('last');
const localKeyEl = document.getElementById('localKey');
const logEl = document.getElementById('log');

function log(...args){
  console.log(...args);
  try {
    const text = args.map(a => (typeof a==='object'? JSON.stringify(a): String(a))).join(' ');
    logEl.textContent = text + '\n' + logEl.textContent;
  } catch(e){}
}

function localKeyFor(fid){
  return 'badgehub_debug_' + (fid||'anon').trim().replace(/\s+/g,'_').toLowerCase();
}

function readRecord(fid){
  try{
    const v = localStorage.getItem(localKeyFor(fid));
    log('readRecord key:', localKeyFor(fid), 'raw:', v);
    return v ? JSON.parse(v) : null;
  }catch(e){ log('readRecord error', e); return null; }
}
function writeRecord(fid, rec){
  try{
    localStorage.setItem(localKeyFor(fid), JSON.stringify(rec));
    log('writeRecord stored', rec);
  }catch(e){ log('writeRecord error', e); }
}

function now(){ return Date.now(); }
const DAY = 24*60*60*1000;

function canClaim(fid){
  const r = readRecord(fid);
  if(!r) return true;
  if(!r.last) return true;
  return (now() - r.last) >= DAY;
}

function timeLeftMs(fid){
  const r = readRecord(fid);
  if(!r || !r.last) return 0;
  const left = DAY - (now() - r.last);
  return left>0 ? left : 0;
}

function updateUI(){
  const fid = (fidInput.value||'anon').trim();
  const r = readRecord(fid);
  localKeyEl.textContent = localKeyFor(fid);
  if(r){
    badgeArea.textContent = (r.fid||fid).toUpperCase() + ' — ' + r.total + ' times';
    streakEl.textContent = r.streak || 0;
    totalEl.textContent = r.total || 0;
    lastEl.textContent = r.last ? new Date(r.last).toLocaleString() : '-';
    raw.textContent = JSON.stringify(r, null, 2);
  } else {
    badgeArea.textContent = '— no badge yet —';
    streakEl.textContent = '0';
    totalEl.textContent = '0';
    lastEl.textContent = '-';
    raw.textContent = '-';
  }
  if(canClaim(fid)){
    claimBtn.disabled = false;
    claimBtn.textContent = "Claim today's badge";
  } else {
    claimBtn.disabled = true;
    const ms = timeLeftMs(fid);
    claimBtn.textContent = "Locked for " + Math.ceil(ms/1000) + "s";
    // optional visual countdown in console
    log('Locked ms left:', ms);
  }
}

function showMessage(text, type='ok'){
  msg.style.display = 'block';
  msg.className = 'msg ' + (type==='ok' ? 'ok' : 'err');
  msg.textContent = text;
  setTimeout(()=>{ msg.style.display = 'none'; }, 4000);
}

claimBtn.addEventListener('click', function(e){
  log('claim button clicked', {fid: fidInput.value});
  try{
    const fid = (fidInput.value||'anon').trim();
    if(!fid){ showMessage('Please enter FID', 'err'); log('empty fid'); return; }
    if(!canClaim(fid)){ showMessage('Already claimed in last 24h', 'err'); log('cannot claim yet'); updateUI(); return; }
    const prev = readRecord(fid) || {fid, streak:0, total:0, last:0};
    // if gap <= 48h count as consecutive streak, else reset streak
    const gap = now() - (prev.last || 0);
    const consecutive = (prev.last && gap <= (2*DAY));
    const newStreak = consecutive ? (prev.streak||0) + 1 : 1;
    const newTotal = (prev.total||0) + 1;
    const rec = { fid, streak: newStreak, total: newTotal, last: now() };
    writeRecord(fid, rec);
    updateUI();
    showMessage('Claim saved — streak ' + newStreak, 'ok');
    log('claim saved', rec);
  }catch(err){
    log('claim handler error', err);
    showMessage('Claim failed (see console)', 'err');
  }
});

// when fid input changes update UI
fidInput.addEventListener('input', updateUI);

// initial load
(function init(){
  try{
    log('Init start, localStorage available?', typeof localStorage !== 'undefined');
    updateUI();
    log('Init done');
  }catch(e){
    log('Init error', e);
    showMessage('Init error (see console)', 'err');
  }
})();
</script>
</body>
</html>
